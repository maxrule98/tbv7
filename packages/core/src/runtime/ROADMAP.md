# Unified Runtime Refactor – Step A

This table captures every file that currently participates in strategy loading/runtime wiring. The "Action" column maps directly to the Step A buckets (KEEP, MOVE INTO RUNTIME, DELETE, ADAPTER) so the rest of the refactor can proceed without rediscovering the same paths.

| Path                                                        | Role Today                                                                         | Notes                                                                                                                                   | Action                        |
| ----------------------------------------------------------- | ---------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------- |
| packages/core/src/config.ts                                 | Central entrypoint for `loadAgenaiConfig`, `loadStrategyConfig`, profile inference | Most helpers remain, but the new runtime loader inside `@agenai/runtime` will call into these instead of duplicating env/profile logic. | KEEP (shared helpers)         |
| packages/core/src/strategies/loadStrategy.ts                | Registry-aware loader that builds dependencies/cache + instantiates strategies     | Already the canonical way to hydrate strategies; the unified runtime should import this rather than duplicating builders.               | KEEP                          |
| packages/core/src/strategies/registry.ts                    | Discovers strategy modules, exposes manifests                                      | Needed for runtime metadata + profile resolution.                                                                                       | KEEP                          |
| packages/core/src/strategies/runtimeConfig.ts               | Produces `StrategyRuntimeParams` (symbol/timeframes/execution frame)               | New runtime metadata builder (inside `packages/runtime`) will wrap this logic instead of reimplementing.                                | KEEP                          |
| packages/core/src/strategies/profiles.ts                    | Resolves default strategy profile names                                            | Still required for selecting configs when CLIs provide overrides.                                                                       | KEEP                          |
| packages/trader-runtime/src/startTrader.ts                  | Orchestrates live runtime (config load, metadata, polling loop)                    | Business logic must relocate into the new `packages/runtime` package so CLIs share it.                                                  | MOVE INTO RUNTIME             |
| packages/trader-runtime/src/runtimeFactory.ts               | Computes metadata + lazy builder wiring                                            | Becomes part of `packages/runtime/src/createRuntime.ts`; no reason to leave it in an app-specific package.                              | MOVE INTO RUNTIME             |
| packages/trader-runtime/src/runtimeShared.ts                | Logging helpers, fingerprinting, execution helpers                                 | Contents should be split between `packages/runtime/src/runtimeLogger.ts` (logging) and inline helpers inside new runtime modules.       | MOVE INTO RUNTIME             |
| packages/trader-runtime/src/strategyBuilders.ts             | Live-only builder wrapping `loadStrategy` with Mexc cache                          | Replace with provider-agnostic builder inside `packages/runtime/src/buildStrategy.ts`.                                                  | MOVE INTO RUNTIME             |
| packages/trader-runtime/src/types.ts                        | Defines `TraderStrategy` contract                                                  | Relocate to `packages/runtime/src/types.ts` so both live + backtest share it.                                                           | MOVE INTO RUNTIME             |
| packages/trader-runtime/src/backtest/backtestRunner.ts      | Historical runner with bespoke config + execution wiring                           | Needs to be rewritten on top of the shared runtime pipeline housed in `packages/runtime`.                                               | MOVE INTO RUNTIME             |
| packages/trader-runtime/src/backtest/backtestCli.ts         | Legacy CLI wrapper around `backtestRunner`                                         | Replace with new `apps/backtest-cli` entrypoint wired to `@agenai/runtime`.                                                             | DELETE after migration        |
| packages/trader-runtime/src/backtest/backtestTypes.ts       | Derived types for backtest results                                                 | Move next to the new runtime so both live + backtest export the same structures.                                                        | MOVE INTO RUNTIME             |
| packages/trader-runtime/src/runtimeFactory.test.ts          | Coverage for metadata fingerprints + builder wiring                                | Move tests alongside the new runtime factory implementation.                                                                            | MOVE INTO RUNTIME             |
| packages/trader-runtime/src/backtest/backtestRunner.test.ts | Backtest-specific coverage of execution loop                                       | Update tests to exercise the new shared runtime; remove the old copy afterward.                                                         | MOVE INTO RUNTIME             |
| apps/backtest-cli/src/index.ts                              | CLI bootstrapper that currently recreates config loading + fingerprint logic       | Will shrink to: parse args → call `@agenai/runtime` APIs (`loadRuntimeConfig()`, `runBacktest()`).                                      | ADAPTER (wrap shared runtime) |
| apps/trader-server/src/index.ts                             | HTTP wrapper that still performs its own config selection and builder wiring       | Reduce to argument parsing + `@agenai/runtime.startLive()` call.                                                                        | ADAPTER                       |
| packages/trader-runtime/src/index.ts                        | Barrel exporting legacy APIs                                                       | After migration this file should either re-export the new package or be removed.                                                        | ADAPTER (temporary)           |
| scripts/processBacktestMetrics.ts                           | Reads output JSON (currently missing per-bar info)                                 | Keep script but update expectations once backtest output schema changes.                                                                | KEEP                          |

## Gaps Discovered

- There is no single place that produces per-bar diagnostics for backtests; this will live inside the new runtime loop so we can reuse the live decision logging.
- Profile overrides are computed three times (CLI, backtest runner, startTrader). The new `packages/runtime/src/loadConfig.ts` should centralize that logic.
- Backtest JSON currently lacks the `configFingerprint` and `timeframeFingerprint` entries emitted in live logs. The shared runtime metadata module will add them once extracted.

With this mapping in place we can proceed to Step B: create the `packages/runtime` package, define the runtime interfaces (`RuntimeContext`, `RuntimeArtifacts`, `SharedBuilderOptions`), and begin porting code into it.
