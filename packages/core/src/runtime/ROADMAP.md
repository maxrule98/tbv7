# Unified Runtime Refactor – Step A

This table captures every file that currently participates in strategy loading/runtime wiring. The "Action" column maps directly to the Step A buckets (KEEP, MOVE INTO RUNTIME, DELETE, ADAPTER) so the rest of the refactor can proceed without rediscovering the same paths.

| Path                                                 | Role Today                                                                         | Notes                                                                                                                                   | Action                        |
| ---------------------------------------------------- | ---------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------- |
| packages/core/src/config.ts                          | Central entrypoint for `loadAgenaiConfig`, `loadStrategyConfig`, profile inference | Most helpers remain, but the new runtime loader inside `@agenai/runtime` will call into these instead of duplicating env/profile logic. | KEEP (shared helpers)         |
| packages/core/src/strategies/loadStrategy.ts         | Registry-aware loader that builds dependencies/cache + instantiates strategies     | Already the canonical way to hydrate strategies; the unified runtime should import this rather than duplicating builders.               | KEEP                          |
| packages/core/src/strategies/registry.ts             | Discovers strategy modules, exposes manifests                                      | Needed for runtime metadata + profile resolution.                                                                                       | KEEP                          |
| packages/core/src/strategies/runtimeConfig.ts        | Produces `StrategyRuntimeParams` (symbol/timeframes/execution frame)               | New runtime metadata builder (inside `packages/runtime`) will wrap this logic instead of reimplementing.                                | KEEP                          |
| packages/core/src/strategies/profiles.ts             | Resolves default strategy profile names                                            | Still required for selecting configs when CLIs provide overrides.                                                                       | KEEP                          |
| packages/runtime/src/startTrader.ts                  | Orchestrates live runtime (config load, metadata, polling loop)                    | Canonical implementation; CLIs and servers import it directly from `@agenai/runtime`.                                                   | KEEP (canonical)              |
| packages/runtime/src/runtimeFactory.ts               | Computes metadata + lazy builder wiring                                            | Lives beside the snapshot utilities so both live + backtest use the same artifacts.                                                     | KEEP (canonical)              |
| packages/runtime/src/runtimeShared.ts                | Logging helpers, fingerprinting, execution helpers                                 | Shared logger + helpers now centralized; no duplicate emitters exist outside this module.                                               | KEEP (canonical)              |
| packages/runtime/src/strategyBuilders.ts             | Live-only builder wrapping `loadStrategy` with Mexc cache                          | Resides in canonical runtime package; adapters inject overrides when needed.                                                            | KEEP (canonical)              |
| packages/runtime/src/types.ts                        | Defines `TraderStrategy` contract                                                  | Shared between live + backtest consumers via `@agenai/runtime`.                                                                         | KEEP (canonical)              |
| packages/runtime/src/backtest/backtestRunner.ts      | Historical runner with bespoke config + execution wiring                           | Rewritten on top of the shared runtime snapshot so CLI + metrics stay in sync.                                                          | KEEP (canonical)              |
| packages/runtime/src/backtest/backtestTypes.ts       | Derived types for backtest results                                                 | Exported from `@agenai/runtime` to downstream tooling (metrics, dashboards, etc.).                                                      | KEEP (canonical)              |
| packages/runtime/src/runtimeFactory.test.ts          | Coverage for metadata fingerprints + builder wiring                                | Tests live next to the runtime factory to guard parity regressions.                                                                     | KEEP (canonical)              |
| packages/runtime/src/backtest/backtestRunner.test.ts | Backtest-specific coverage of execution loop                                       | Exercises the shared runtime path; replaces the deleted legacy tests.                                                                   | KEEP (canonical)              |
| apps/backtest-cli/src/index.ts                       | CLI bootstrapper that currently recreates config loading + fingerprint logic       | Will shrink to: parse args → call `@agenai/runtime` APIs (`loadRuntimeConfig()`, `runBacktest()`).                                      | ADAPTER (wrap shared runtime) |
| apps/trader-server/src/index.ts                      | HTTP wrapper that still performs its own config selection and builder wiring       | Reduce to argument parsing + `@agenai/runtime.startLive()` call.                                                                        | ADAPTER                       |
| packages/runtime/src/index.ts                        | Barrel exporting unified runtime APIs                                              | Re-exports the canonical live/backtest entrypoints now that the legacy package is removed.                                              | KEEP                          |
| scripts/processBacktestMetrics.ts                    | Reads output JSON (currently missing per-bar info)                                 | Keep script but update expectations once backtest output schema changes.                                                                | KEEP                          |

## Gaps Discovered

- There is no single place that produces per-bar diagnostics for backtests; this will live inside the new runtime loop so we can reuse the live decision logging.
- Profile overrides are computed three times (CLI, backtest runner, startTrader). The new `packages/runtime/src/loadConfig.ts` should centralize that logic.
- Backtest JSON currently lacks the `strategyConfigFingerprint` and `timeframeFingerprint` entries emitted in live logs. The shared runtime metadata module will add them once extracted.

With this mapping in place we can proceed to Step B: create the `packages/runtime` package, define the runtime interfaces (`RuntimeContext`, `RuntimeArtifacts`, `SharedBuilderOptions`), and begin porting code into it.
